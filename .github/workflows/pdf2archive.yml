# Build PDF document from LaTeX source
name: PDF/A Validation
on: 
  workflow_run: # trigger after the LaTeXmk build
    workflows: ["LaTeXmk Build"]
    types:
      - completed
  workflow_dispatch: # manual (convert latest pdf)
jobs:
  pdf2archive-RUN:
    runs-on: ubuntu-latest
    steps:
      - name: Retrieve PDF from LaTeXmk build
        uses: dawidd6/action-download-artifact@v2
        with:
          # Required, workflow file name or ID
          workflow: latex_build.yml
          workflow_conclusion: success # act only on succesfull builds
          name: download
          path: latex-build/
      - name: Retrieve GHOSTSCRIPT
        run : | # External dependency for pdf2archive
          sudo apt-get update
          sudo apt-get install ghostscript -y
      - name: Retrieve PDF2ARCHIVE
        uses: actions/checkout@v3
        with:
          repository: matteosecli/pdf2archive
          path: pdf2archive/
      - name: Setup PDF2ARCHIVE root and input
        run: | # also give run-permissions to the script
          mv latex-build/draft.pdf pdf2archive/latex.pdf
          cd pdf2archive/
          chmod +x pdf2archive
          ls -lh pdf2archive
      - name: Convert to PDF/A-1b ISO standard
        run: ./pdf2archive --title="Valutazione infermieristica della qualita' della sedazione procedurale pediatrica" --subject="Nursing assessment of the quality of pediatric procedural sedation" --keywords="sedazione procedurale, pediatria, risveglio, qualita' del risveglio" --author="Anais Trinca" latex.pdf esse3.pdf
      - name: Setup JAVA runtime for validation
        uses: oracle-actions/setup-java@v1
        with:
          website: oracle.com
          release: 17
      - name: Validate the standard via veraPDF
        run: ./pdf2archive --validate-only
      - name: Prepare artifact to upload
        run : | # pack output directory
          mv esse3.pdf ../output/esse3.pdf
          cd ..
      - name: Upload artifact to actions tab
        uses: actions/upload-artifact@master
        with:
          name: download
          path: output